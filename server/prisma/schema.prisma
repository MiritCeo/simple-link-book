generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  OWNER
  STAFF
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum BreakType {
  BREAK
  BUFFER
}

enum NotificationEvent {
  BOOKING_CONFIRMATION
  REMINDER_24H
  REMINDER_2H
  CANCELLATION
  FOLLOWUP
}

enum NotificationChannel {
  SMS
  EMAIL
}

enum AppointmentTokenType {
  CANCEL
}

model Salon {
  id          String   @id @default(cuid())
  slug        String   @unique
  name        String
  address     String
  phone       String
  hours       String
  description String
  accentColor String?
  logoUrl     String?  @db.Text
  createdAt   DateTime @default(now())

  users        User[]
  services     Service[]
  staff        Staff[]
  clients      Client[]
  appointments Appointment[]
  salonHours      SalonHour[]
  salonExceptions SalonException[]
  salonBreaks     SalonBreak[]
  userSalons      UserSalon[]
  notificationSettings  NotificationSetting[]
  notificationTemplates NotificationTemplate[]
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  phone        String
  passwordHash String
  role         UserRole
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())

  salon   Salon? @relation(fields: [salonId], references: [id])
  salonId String?

  userSalons UserSalon[]
  staff      Staff?
}

model Service {
  id          String   @id @default(cuid())
  name        String
  category    String
  duration    Int
  price       Int
  description String?
  active      Boolean  @default(true)

  salon   Salon  @relation(fields: [salonId], references: [id])
  salonId String

  staffServices StaffService[]
  appointmentServices AppointmentService[]
}

model Staff {
  id        String   @id @default(cuid())
  name      String
  role      String
  phone     String?
  active    Boolean  @default(true)
  createdAt DateTime @default(now())

  salon   Salon  @relation(fields: [salonId], references: [id])
  salonId String
  userId  String? @unique
  user    User?   @relation(fields: [userId], references: [id])

  staffServices StaffService[]
  appointments  Appointment[]
  availability  StaffAvailability[]
  exceptions    StaffException[]
}

model StaffService {
  staffId   String
  serviceId String

  staff   Staff   @relation(fields: [staffId], references: [id])
  service Service @relation(fields: [serviceId], references: [id])

  @@id([staffId, serviceId])
}

model Client {
  id        String   @id @default(cuid())
  name      String
  phone     String
  email     String?
  notes     String?
  active    Boolean  @default(true)
  createdAt DateTime @default(now())

  salon   Salon  @relation(fields: [salonId], references: [id])
  salonId String

  appointments Appointment[]
}

model Appointment {
  id        String   @id @default(cuid())
  date      String
  time      String
  duration  Int
  status    AppointmentStatus @default(SCHEDULED)
  notes     String?
  createdAt DateTime @default(now())

  salon   Salon  @relation(fields: [salonId], references: [id])
  salonId String

  client   Client @relation(fields: [clientId], references: [id])
  clientId String

  staff   Staff?  @relation(fields: [staffId], references: [id])
  staffId String?

  appointmentServices AppointmentService[]
  notificationLogs    NotificationLog[]
  tokens              AppointmentToken[]
}

model AppointmentToken {
  id            String               @id @default(cuid())
  appointmentId String
  token         String               @unique
  type          AppointmentTokenType
  expiresAt     DateTime
  usedAt        DateTime?
  createdAt     DateTime             @default(now())

  appointment Appointment @relation(fields: [appointmentId], references: [id])

  @@index([appointmentId, type])
}

model AppointmentService {
  appointmentId String
  serviceId     String

  appointment Appointment @relation(fields: [appointmentId], references: [id])
  service     Service     @relation(fields: [serviceId], references: [id])

  @@id([appointmentId, serviceId])
}

model StaffAvailability {
  id       String @id @default(cuid())
  weekday  Int
  start    String
  end      String
  active   Boolean @default(true)

  staff   Staff  @relation(fields: [staffId], references: [id])
  staffId String
}

model StaffException {
  id       String  @id @default(cuid())
  date     String
  start    String?
  end      String?
  label    String?
  active   Boolean @default(false)

  staff   Staff  @relation(fields: [staffId], references: [id])
  staffId String
}

model SalonHour {
  id       String  @id @default(cuid())
  weekday  Int
  open     String
  close    String
  active   Boolean @default(true)

  salon   Salon  @relation(fields: [salonId], references: [id])
  salonId String

  @@unique([salonId, weekday])
}

model SalonException {
  id       String  @id @default(cuid())
  date     String
  label    String?
  start    String?
  end      String?
  closed   Boolean @default(false)

  salon   Salon  @relation(fields: [salonId], references: [id])
  salonId String
}

model SalonBreak {
  id       String   @id @default(cuid())
  type     BreakType
  label    String
  days     String?
  start    String?
  end      String?
  minutes  Int?

  salon   Salon  @relation(fields: [salonId], references: [id])
  salonId String
}

model UserSalon {
  userId  String
  salonId String
  role    UserRole

  user  User  @relation(fields: [userId], references: [id])
  salon Salon @relation(fields: [salonId], references: [id])

  @@id([userId, salonId])
}

model NotificationSetting {
  id            String            @id @default(cuid())
  event         NotificationEvent
  smsEnabled    Boolean           @default(true)
  emailEnabled  Boolean           @default(true)
  timingMinutes Int?

  salon   Salon  @relation(fields: [salonId], references: [id])
  salonId String

  @@unique([salonId, event])
}

model NotificationTemplate {
  id        String              @id @default(cuid())
  event     NotificationEvent
  channel   NotificationChannel
  subject   String?
  body      String
  active    Boolean             @default(true)

  salon   Salon  @relation(fields: [salonId], references: [id])
  salonId String

  @@unique([salonId, event, channel])
}

model NotificationLog {
  id            String              @id @default(cuid())
  appointmentId String
  event         NotificationEvent
  channel       NotificationChannel
  sentAt        DateTime            @default(now())

  appointment Appointment @relation(fields: [appointmentId], references: [id])

  @@unique([appointmentId, event, channel])
}
